<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cartonization Algorithm Comparison</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="cartonization.bundle.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0f;
      color: #e0e0e0;
      overflow: hidden;
    }
    
    /* Top Navigation */
    .top-nav {
      background: #12121a;
      border-bottom: 1px solid #2a2a3a;
      padding: 0 20px;
      display: flex;
      align-items: center;
      height: 48px;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    
    .nav-brand {
      font-size: 14px;
      font-weight: 600;
      color: #fff;
      margin-right: 30px;
    }
    
    .nav-links {
      display: flex;
      gap: 4px;
    }
    
    .nav-link {
      padding: 8px 16px;
      color: #888;
      text-decoration: none;
      font-size: 12px;
      font-weight: 500;
      border-radius: 4px;
      transition: all 0.15s;
    }
    
    .nav-link:hover {
      color: #fff;
      background: #1a1a25;
    }
    
    .nav-link.active {
      color: #4a9eff;
      background: rgba(74, 158, 255, 0.1);
    }
    
    .container {
      display: grid;
      grid-template-columns: 280px 1fr 280px;
      height: calc(100vh - 48px);
      width: 100vw;
    }
    
    /* Left Panel - Product Search */
    .panel-left {
      grid-column: 1;
      background: #12121a;
      border-right: 1px solid #2a2a3a;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    /* Center - Three Algorithm Panes */
    .panel-center {
      grid-column: 2;
      display: flex;
      flex-direction: column;
      background: #08080c;
      min-width: 0;
    }
    
    /* Right Panel */
    .panel-right {
      grid-column: 3;
      background: #12121a;
      border-left: 1px solid #2a2a3a;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .panel-header {
      padding: 12px;
      border-bottom: 1px solid #2a2a3a;
    }
    
    .panel-header h2 {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #888;
      margin-bottom: 10px;
    }
    
    .search-box {
      width: 100%;
      padding: 8px 10px;
      background: #1a1a25;
      border: 1px solid #2a2a3a;
      border-radius: 4px;
      color: #fff;
      font-size: 12px;
      outline: none;
    }
    
    .search-box:focus { border-color: #4a9eff; }
    
    .product-list {
      flex: 1;
      overflow-y: auto;
      padding: 6px;
    }
    
    .product-item {
      padding: 8px 10px;
      background: #1a1a25;
      border-radius: 4px;
      margin-bottom: 4px;
      cursor: pointer;
      transition: all 0.15s;
      border: 1px solid transparent;
    }
    
    .product-item:hover {
      background: #22222f;
      border-color: #3a3a4a;
    }
    
    .product-item .sku { font-size: 9px; color: #666; }
    .product-item .name { font-size: 11px; color: #fff; margin: 2px 0; line-height: 1.3; }
    .product-item .dims { font-size: 9px; color: #4a9eff; }
    
    .views-container {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 1px;
      background: #2a2a3a;
      min-height: 0;
    }
    
    .view-pane {
      position: relative;
      background: #08080c;
      min-width: 0;
      min-height: 0;
      overflow: hidden;
    }
    
    .view-pane canvas { 
      position: absolute;
      top: 0;
      left: 0;
      width: 100% !important; 
      height: 100% !important;
      display: block;
    }
    
    .view-label {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.85);
      padding: 6px 12px;
      border-radius: 4px;
      text-align: center;
      border: 1px solid #2a2a3a;
      z-index: 10;
    }
    
    .view-label .algo-name {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 3px;
    }
    
    .view-label .box-name { font-size: 12px; font-weight: 600; color: #fff; }
    .view-label .box-dims { font-size: 10px; color: #888; margin-top: 2px; }
    
    .view-pane.ffd .algo-name { color: #4a9eff; }
    .view-pane.ebafit .algo-name { color: #44cc88; }
    .view-pane.multipass .algo-name { color: #b388ff; }
    
    .status-badge {
      position: absolute;
      bottom: 70px;
      left: 50%;
      transform: translateX(-50%);
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 10px;
      font-weight: 600;
      z-index: 10;
    }
    
    .status-badge.success { background: rgba(68, 204, 136, 0.2); border: 1px solid #44cc88; color: #44cc88; }
    .status-badge.failed { background: rgba(255, 107, 107, 0.2); border: 1px solid #ff6b6b; color: #ff6b6b; }
    .status-badge.winner { background: rgba(255, 217, 61, 0.2); border: 1px solid #ffd93d; color: #ffd93d; }
    
    /* Stats Bar */
    .stats-bar {
      background: #0d0d12;
      border-top: 1px solid #2a2a3a;
      padding: 10px 15px;
      overflow-x: auto;
      flex-shrink: 0;
      position: sticky;
      bottom: 0;
      z-index: 100;
    }
    
    .stats-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }
    
    .stats-table th {
      text-align: left;
      color: #666;
      font-weight: 500;
      text-transform: uppercase;
      font-size: 9px;
      letter-spacing: 0.5px;
      padding: 4px 8px;
      border-bottom: 1px solid #2a2a3a;
    }
    
    .stats-table td {
      padding: 6px 8px;
      border-bottom: 1px solid #1a1a25;
    }
    
    .stats-table tr.ffd td:first-child { color: #4a9eff; }
    .stats-table tr.ebafit td:first-child { color: #44cc88; }
    .stats-table tr.multipass td:first-child { color: #b388ff; }
    
    .stats-table .winner { background: rgba(255, 217, 61, 0.1); }
    .stats-table .winner td { font-weight: 600; }
    
    .stats-table .number { font-family: 'SF Mono', Monaco, 'Courier New', monospace; }
    
    /* Cart Section */
    .cart-section {
      padding: 12px;
      border-bottom: 1px solid #2a2a3a;
      flex-shrink: 0;
    }
    
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .section-header h2 {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #888;
    }
    
    .cart-count {
      background: #4a9eff;
      color: #fff;
      font-size: 9px;
      padding: 2px 6px;
      border-radius: 8px;
    }
    
    /* Settings Row */
    .settings-row {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }
    
    .setting-group {
      flex: 1;
      background: #1a1a25;
      padding: 8px;
      border-radius: 4px;
    }
    
    .setting-group label {
      display: block;
      font-size: 9px;
      color: #666;
      margin-bottom: 4px;
      text-transform: uppercase;
    }
    
    .setting-group input, .setting-group select {
      width: 100%;
      padding: 4px 6px;
      background: #0d0d12;
      border: 1px solid #2a2a3a;
      border-radius: 3px;
      color: #fff;
      font-size: 11px;
    }
    
    .setting-group input:focus, .setting-group select:focus {
      outline: none;
      border-color: #4a9eff;
    }
    
    .cart-empty { color: #555; font-size: 11px; text-align: center; padding: 15px; }
    
    .cart-list {
      max-height: 150px;
      overflow-y: auto;
    }
    
    .cart-item {
      display: flex;
      align-items: center;
      padding: 6px 8px;
      background: #1a1a25;
      border-radius: 4px;
      margin-bottom: 4px;
    }
    
    .cart-item .item-color {
      width: 8px;
      height: 8px;
      border-radius: 2px;
      margin-right: 8px;
      flex-shrink: 0;
    }
    
    .cart-item .item-info { flex: 1; min-width: 0; }
    .cart-item .item-name { font-size: 10px; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .cart-item .item-dims { font-size: 9px; color: #666; }
    
    .cart-item .item-qty { display: flex; align-items: center; gap: 3px; flex-shrink: 0; }
    
    .cart-item .qty-btn {
      width: 18px;
      height: 18px;
      border: none;
      background: #2a2a3a;
      color: #fff;
      border-radius: 3px;
      cursor: pointer;
      font-size: 11px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .cart-item .qty-btn:hover { background: #3a3a4a; }
    .cart-item .qty-btn.remove { background: #4a2a2a; color: #ff6b6b; margin-left: 3px; }
    .cart-item .qty-btn.remove:hover { background: #5a3a3a; }
    .cart-item .qty-value { font-size: 11px; min-width: 14px; text-align: center; }
    
    /* Box Inventory Sections */
    .boxes-section {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
      min-height: 0;
    }
    
    .box-category {
      margin-bottom: 8px;
    }
    
    .category-header {
      display: flex;
      align-items: center;
      padding: 8px 10px;
      background: #1a1a25;
      border-radius: 4px;
      cursor: pointer;
      user-select: none;
    }
    
    .category-header:hover { background: #22222f; }
    
    .category-toggle {
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 8px;
      font-size: 10px;
      color: #666;
      transition: transform 0.2s;
    }
    
    .category-header.collapsed .category-toggle { transform: rotate(-90deg); }
    
    .category-name {
      flex: 1;
      font-size: 11px;
      font-weight: 600;
    }
    
    .category-name.texas-art { color: #4a9eff; }
    .category-name.usps { color: #3d85c6; }
    .category-name.fedex { color: #9b59b6; }
    .category-name.ups { color: #d4a574; }
    
    .category-count {
      font-size: 9px;
      color: #666;
      background: #0d0d12;
      padding: 2px 6px;
      border-radius: 8px;
    }
    
    .category-boxes {
      padding: 6px 0 6px 24px;
    }
    
    .category-header.collapsed + .category-boxes { display: none; }
    
    .box-item {
      display: flex;
      align-items: center;
      padding: 5px 8px;
      border-radius: 3px;
      cursor: pointer;
      transition: all 0.15s;
      margin-bottom: 2px;
    }
    
    .box-item:hover { background: #1a1a25; }
    .box-item.disabled { opacity: 0.35; }
    
    .box-item .box-check {
      width: 14px;
      height: 14px;
      border: 2px solid #3a3a4a;
      border-radius: 2px;
      margin-right: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      transition: all 0.15s;
      flex-shrink: 0;
    }
    
    .box-item.enabled .box-check {
      background: #4a9eff;
      border-color: #4a9eff;
    }
    
    .box-item.enabled .box-check::after { content: '✓'; color: #fff; }
    
    .box-item.selected { background: rgba(68, 204, 136, 0.15); }
    .box-item.selected .box-name { color: #44cc88; font-weight: 600; }
    
    .box-item .box-info { flex: 1; min-width: 0; }
    .box-item .box-name { font-size: 10px; color: #ccc; }
    .box-item .box-dims { font-size: 9px; color: #666; }
    
    .box-actions {
      display: flex;
      gap: 6px;
      margin-bottom: 10px;
    }
    
    .box-action-btn {
      flex: 1;
      padding: 5px 8px;
      background: #1a1a25;
      border: 1px solid #2a2a3a;
      border-radius: 3px;
      color: #888;
      font-size: 9px;
      cursor: pointer;
    }
    
    .box-action-btn:hover { background: #22222f; color: #fff; }
    
    /* Scrollbar */
    ::-webkit-scrollbar { width: 5px; }
    ::-webkit-scrollbar-track { background: #1a1a25; }
    ::-webkit-scrollbar-thumb { background: #3a3a4a; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #4a4a5a; }
    
    .loading { display: flex; align-items: center; justify-content: center; height: 100%; color: #555; font-size: 12px; }
  </style>
</head>
<body>
  <nav class="top-nav">
    <div class="nav-brand">Cartonization Demo</div>
    <div class="nav-links">
      <a href="index.html" class="nav-link active">Visualizer</a>
      <a href="simulator.html" class="nav-link">Batch Simulator</a>
    </div>
  </nav>
  
  <div class="container">
    <!-- Left Panel: Product Search -->
    <div class="panel-left">
      <div class="panel-header">
        <h2>Product Catalog</h2>
        <input type="text" class="search-box" id="search" placeholder="Search by SKU or name...">
      </div>
      <div class="product-list" id="product-list">
        <div class="loading">Loading products...</div>
      </div>
    </div>
    
    <!-- Center: Three Algorithm Panes -->
    <div class="panel-center">
      <div class="views-container">
        <div class="view-pane ffd" id="view-ffd">
          <div class="view-label">
            <div class="algo-name">FFD (Current)</div>
            <div class="box-name" id="ffd-box-name">No items</div>
            <div class="box-dims" id="ffd-box-dims">Add items to cart</div>
          </div>
        </div>
        <div class="view-pane ebafit" id="view-ebafit">
          <div class="view-label">
            <div class="algo-name">EB-AFIT</div>
            <div class="box-name" id="ebafit-box-name">No items</div>
            <div class="box-dims" id="ebafit-box-dims">Add items to cart</div>
          </div>
        </div>
        <div class="view-pane multipass" id="view-multipass">
          <div class="view-label">
            <div class="algo-name">Multi-Pass FFD</div>
            <div class="box-name" id="multipass-box-name">No items</div>
            <div class="box-dims" id="multipass-box-dims">Add items to cart</div>
          </div>
        </div>
      </div>
      
      <!-- Stats Comparison Bar -->
      <div class="stats-bar">
        <table class="stats-table" id="stats-table">
          <thead>
            <tr>
              <th>Algorithm</th>
              <th>Box Selected</th>
              <th>Box Volume</th>
              <th>Fill %</th>
              <th>DIM Wt</th>
              <th>Billable</th>
              <th>Time</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="stats-body">
            <tr><td colspan="8" style="text-align: center; color: #555;">Add items to compare algorithms</td></tr>
          </tbody>
        </table>
      </div>
    </div>
    
    <!-- Right Panel: Cart & Box Management -->
    <div class="panel-right">
      <div class="cart-section">
        <div class="section-header">
          <h2>Cart</h2>
          <span class="cart-count" id="cart-count">0</span>
        </div>
        
        <div class="settings-row">
          <div class="setting-group">
            <label>Padding</label>
            <input type="number" id="padding-input" value="0" min="0" max="2" step="0.125">
          </div>
          <div class="setting-group">
            <label>DIM Divisor</label>
            <select id="dim-divisor">
              <option value="139">139</option>
              <option value="166">166</option>
              <option value="194">194</option>
              <option value="220" selected>220</option>
            </select>
          </div>
        </div>
        
        <div class="cart-list" id="cart-list">
          <div class="cart-empty">Click products to add</div>
        </div>
      </div>
      
      <div class="boxes-section">
        <div class="section-header" style="margin-bottom: 10px;">
          <h2>Boxes</h2>
        </div>
        <div class="box-actions">
          <button class="box-action-btn" onclick="toggleAllBoxes(true)">Enable All</button>
          <button class="box-action-btn" onclick="toggleAllBoxes(false)">Disable All</button>
        </div>
        <div id="box-categories"></div>
      </div>
    </div>
  </div>

  <script>
    let products = [];
    let boxCategories = {};
    let enabledBoxes = new Set();
    let collapsedCategories = new Set(['texasArt']); // Texas Art collapsed by default
    let cart = [];
    let cartonService = null;
    let selectedBoxes = { ffd: null, ebafit: null, multipass: null };
    
    const itemColors = [
      0x4a9eff, 0x44cc88, 0xff6b6b, 0xffd93d, 0x6c5ce7,
      0x00cec9, 0xfd79a8, 0xe17055, 0x74b9ff, 0x55efc4
    ];
    let colorIndex = 0;
    
    const views = {};
    let isRotating = true;
    
    function initThreeJS() {
      const paneIds = ['view-ffd', 'view-ebafit', 'view-multipass'];
      
      paneIds.forEach(id => {
        const container = document.getElementById(id);
        const rect = container.getBoundingClientRect();
        
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x08080c);
        
        const camera = new THREE.PerspectiveCamera(45, rect.width / rect.height, 0.1, 1000);
        camera.position.set(30, 22, 30);
        camera.lookAt(0, 0, 0);
        
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(rect.width, rect.height);
        renderer.setPixelRatio(window.devicePixelRatio);
        container.appendChild(renderer.domElement);
        
        addLightsAndGrid(scene);
        setupControls(renderer.domElement, camera);
        
        views[id] = { scene, camera, renderer, boxGroup: null };
      });
      
      window.addEventListener('resize', handleResize);
      animate();
    }
    
    let resizeTimeout;
    function handleResize() {
      // Debounce resize to avoid layout thrashing
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        Object.entries(views).forEach(([id, view]) => {
          const container = document.getElementById(id);
          // Force container to recalculate by temporarily hiding canvas influence
          const canvas = container.querySelector('canvas');
          if (canvas) canvas.style.display = 'none';
          const rect = container.getBoundingClientRect();
          if (canvas) canvas.style.display = 'block';
          
          if (rect.width > 0 && rect.height > 0) {
            view.camera.aspect = rect.width / rect.height;
            view.camera.updateProjectionMatrix();
            view.renderer.setSize(rect.width, rect.height);
          }
        });
      }, 50);
    }
    
    function addLightsAndGrid(scene) {
      scene.add(new THREE.AmbientLight(0xffffff, 0.6));
      const dir1 = new THREE.DirectionalLight(0xffffff, 0.8);
      dir1.position.set(50, 50, 50);
      scene.add(dir1);
      const dir2 = new THREE.DirectionalLight(0xffffff, 0.3);
      dir2.position.set(-50, 30, -50);
      scene.add(dir2);
      const grid = new THREE.GridHelper(40, 20, 0x2a2a3a, 0x1a1a25);
      grid.position.y = -0.1;
      scene.add(grid);
    }
    
    function setupControls(domElement, camera) {
      let isDragging = false;
      let prev = { x: 0, y: 0 };
      
      domElement.addEventListener('mousedown', () => { isDragging = true; isRotating = false; });
      domElement.addEventListener('mousemove', (e) => {
        if (isDragging) {
          const spherical = new THREE.Spherical();
          spherical.setFromVector3(camera.position);
          spherical.theta -= (e.clientX - prev.x) * 0.01;
          spherical.phi -= (e.clientY - prev.y) * 0.01;
          spherical.phi = Math.max(0.1, Math.min(Math.PI - 0.1, spherical.phi));
          camera.position.setFromSpherical(spherical);
          camera.lookAt(0, 0, 0);
        }
        prev = { x: e.clientX, y: e.clientY };
      });
      domElement.addEventListener('mouseup', () => isDragging = false);
      domElement.addEventListener('mouseleave', () => isDragging = false);
      domElement.addEventListener('wheel', (e) => {
        const dist = camera.position.length();
        camera.position.setLength(Math.max(12, Math.min(70, dist * (1 + (e.deltaY > 0 ? 0.1 : -0.1)))));
      });
    }
    
    function animate() {
      requestAnimationFrame(animate);
      if (isRotating) {
        Object.values(views).forEach(view => {
          const spherical = new THREE.Spherical();
          spherical.setFromVector3(view.camera.position);
          spherical.theta += 0.002;
          view.camera.position.setFromSpherical(spherical);
          view.camera.lookAt(0, 0, 0);
        });
      }
      Object.values(views).forEach(view => view.renderer.render(view.scene, view.camera));
    }
    
    function visualizeResult(viewId, result, boxColor) {
      const view = views[viewId];
      if (view.boxGroup) view.scene.remove(view.boxGroup);
      
      if (!result || !result.box || !result.box.length) {
        view.boxGroup = null;
        return;
      }
      
      const box = result.box;
      const group = new THREE.Group();
      const maxDim = Math.max(box.length, box.width, box.height);
      const scale = 14 / maxDim;
      
      const boxGeo = new THREE.BoxGeometry(box.length * scale, box.height * scale, box.width * scale);
      const edges = new THREE.EdgesGeometry(boxGeo);
      const wire = new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color: boxColor, transparent: true, opacity: 0.8 }));
      wire.renderOrder = 999;
      group.add(wire);
      
      const faces = new THREE.Mesh(boxGeo, new THREE.MeshBasicMaterial({ color: boxColor, transparent: true, opacity: 0.03, side: THREE.BackSide, depthWrite: false }));
      group.add(faces);
      
      if (result.packedItems) {
        result.packedItems.forEach((item, i) => {
          const itemGeo = new THREE.BoxGeometry(item.packedLength * scale, item.packedHeight * scale, item.packedWidth * scale);
          const itemMat = new THREE.MeshPhongMaterial({ color: item.color || itemColors[i % itemColors.length] });
          const itemMesh = new THREE.Mesh(itemGeo, itemMat);
          itemMesh.position.set(
            (item.x + item.packedLength / 2 - box.length / 2) * scale,
            (item.y + item.packedHeight / 2 - box.height / 2) * scale,
            (item.z + item.packedWidth / 2 - box.width / 2) * scale
          );
          group.add(itemMesh);
          
          const edgeGeo = new THREE.EdgesGeometry(itemGeo);
          const itemEdges = new THREE.LineSegments(edgeGeo, new THREE.LineBasicMaterial({ color: 0x000000, transparent: true, opacity: 0.5 }));
          itemEdges.position.copy(itemMesh.position);
          itemEdges.scale.setScalar(1.001);
          group.add(itemEdges);
        });
      }
      
      group.position.y = (box.height * scale) / 2;
      view.scene.add(group);
      view.boxGroup = group;
    }
    
    function runCartonization() {
      if (cart.length === 0) { clearResults(); return; }
      
      const padding = parseFloat(document.getElementById('padding-input').value) || 0;
      const dimDivisor = parseInt(document.getElementById('dim-divisor').value) || 139;
      
      const items = cart.map(c => ({
        sku: c.product.sku, quantity: c.quantity,
        length: c.product.length, width: c.product.width, height: c.product.height,
        weight: c.product.weight, color: c.color
      }));
      
      const activeBoxes = getAllEnabledBoxes();
      cartonService.setBoxInventory(activeBoxes);
      const results = cartonService.packAll(items, padding);
      
      selectedBoxes = { ffd: results.ffd.box?.name, ebafit: results.ebafit.box?.name, multipass: results.multipass.box?.name };
      
      visualizeResult('view-ffd', results.ffd, 0x4a9eff);
      visualizeResult('view-ebafit', results.ebafit, 0x44cc88);
      visualizeResult('view-multipass', results.multipass, 0xb388ff);
      
      updateLabels(results);
      updateStats(results, dimDivisor);
      renderBoxCategories();
    }
    
    function getAllEnabledBoxes() {
      const all = [];
      Object.values(boxCategories).forEach(boxes => boxes.forEach(box => { if (enabledBoxes.has(box.name)) all.push(box); }));
      return all;
    }
    
    function clearResults() {
      Object.keys(views).forEach(id => { if (views[id].boxGroup) { views[id].scene.remove(views[id].boxGroup); views[id].boxGroup = null; } });
      selectedBoxes = { ffd: null, ebafit: null, multipass: null };
      ['ffd', 'ebafit', 'multipass'].forEach(algo => {
        document.getElementById(`${algo}-box-name`).textContent = 'No items';
        document.getElementById(`${algo}-box-dims`).textContent = 'Add items to cart';
      });
      document.getElementById('stats-body').innerHTML = '<tr><td colspan="8" style="text-align: center; color: #555;">Add items to compare algorithms</td></tr>';
      document.querySelectorAll('.status-badge').forEach(el => el.remove());
      renderBoxCategories();
    }
    
    function updateLabels(results) {
      ['ffd', 'ebafit', 'multipass'].forEach(algo => {
        const r = results[algo];
        document.getElementById(`${algo}-box-name`).textContent = r?.box?.length ? r.box.name : 'No fit';
        document.getElementById(`${algo}-box-dims`).textContent = r?.box?.length ? `${r.box.length}" × ${r.box.width}" × ${r.box.height}"` : 'No suitable box';
        
        const pane = document.getElementById(`view-${algo}`);
        let badge = pane.querySelector('.status-badge');
        if (!badge) { badge = document.createElement('div'); badge.className = 'status-badge'; pane.appendChild(badge); }
        badge.className = r.success ? 'status-badge success' : 'status-badge failed';
        badge.textContent = r.success ? 'All packed' : `${r.unpackedItems?.length || 0} unpacked`;
      });
    }
    
    function updateStats(results, dimDivisor) {
      const statsData = {};
      let minBillable = Infinity, winners = [];
      
      ['ffd', 'ebafit', 'multipass'].forEach(algo => {
        const r = results[algo];
        const dimWeight = r.boxVolume / dimDivisor;
        const billable = Math.max(r.totalWeight, dimWeight);
        statsData[algo] = { ...r, dimWeight, billable };
        if (r.success && billable < minBillable) { minBillable = billable; winners = [algo]; }
        else if (r.success && billable === minBillable) winners.push(algo);
      });
      
      winners.forEach(algo => {
        const badge = document.getElementById(`view-${algo}`).querySelector('.status-badge');
        if (badge && statsData[algo].success) { badge.className = 'status-badge winner'; badge.textContent = '★ Best'; }
      });
      
      const algoNames = { ffd: 'FFD (Current)', ebafit: 'EB-AFIT', multipass: 'Multi-Pass FFD' };
      document.getElementById('stats-body').innerHTML = ['ffd', 'ebafit', 'multipass'].map(algo => {
        const s = statsData[algo];
        const isWinner = winners.includes(algo) && s.success;
        return `<tr class="${algo} ${isWinner ? 'winner' : ''}">
          <td>${algoNames[algo]}</td><td>${s.box?.name || 'N/A'}</td>
          <td class="number">${s.boxVolume.toLocaleString()}</td><td class="number">${s.efficiency}%</td>
          <td class="number">${s.dimWeight.toFixed(1)}</td><td class="number">${s.billable.toFixed(1)}</td>
          <td class="number">${s.executionTime.toFixed(1)}ms</td>
          <td>${s.success ? '✓' : `✗ ${s.unpackedItems?.length || 0}`}</td></tr>`;
      }).join('');
    }
    
    function renderProducts(filter = '') {
      const list = document.getElementById('product-list');
      const filtered = products.filter(p => p.sku.toLowerCase().includes(filter.toLowerCase()) || p.product_title.toLowerCase().includes(filter.toLowerCase())).slice(0, 100);
      list.innerHTML = filtered.length === 0 ? '<div class="cart-empty">No products found</div>' :
        filtered.map(p => `<div class="product-item" onclick="addToCart('${p.sku}')">
          <div class="sku">${p.sku}</div><div class="name">${p.product_title}</div>
          <div class="dims">${p.length}" × ${p.width}" × ${p.height}" | ${p.weight} lbs</div></div>`).join('');
    }
    
    function addToCart(sku) {
      const product = products.find(p => p.sku === sku);
      if (!product) return;
      const existing = cart.find(item => item.product.sku === sku);
      if (existing) existing.quantity++; else cart.push({ product, quantity: 1, color: itemColors[colorIndex++ % itemColors.length] });
      renderCart(); runCartonization();
    }
    
    function updateQuantity(sku, delta) {
      const item = cart.find(i => i.product.sku === sku);
      if (!item) return;
      item.quantity += delta;
      if (item.quantity <= 0) cart = cart.filter(i => i.product.sku !== sku);
      renderCart(); runCartonization();
    }
    
    function removeFromCart(sku) { cart = cart.filter(i => i.product.sku !== sku); renderCart(); runCartonization(); }
    
    function renderCart() {
      document.getElementById('cart-count').textContent = cart.reduce((s, i) => s + i.quantity, 0);
      const list = document.getElementById('cart-list');
      list.innerHTML = cart.length === 0 ? '<div class="cart-empty">Click products to add</div>' :
        cart.map(item => `<div class="cart-item">
          <div class="item-color" style="background: #${item.color.toString(16).padStart(6, '0')}"></div>
          <div class="item-info"><div class="item-name">${item.product.product_title}</div>
          <div class="item-dims">${item.product.length}" × ${item.product.width}" × ${item.product.height}"</div></div>
          <div class="item-qty"><button class="qty-btn" onclick="updateQuantity('${item.product.sku}', -1)">−</button>
          <span class="qty-value">${item.quantity}</span><button class="qty-btn" onclick="updateQuantity('${item.product.sku}', 1)">+</button>
          <button class="qty-btn remove" onclick="removeFromCart('${item.product.sku}')">✕</button></div></div>`).join('');
    }
    
    function renderBoxCategories() {
      const container = document.getElementById('box-categories');
      const categoryInfo = { texasArt: { name: 'Texas Art', class: 'texas-art' }, usps: { name: 'USPS', class: 'usps' }, fedex: { name: 'FedEx', class: 'fedex' }, ups: { name: 'UPS', class: 'ups' } };
      const allSelected = new Set([selectedBoxes.ffd, selectedBoxes.ebafit, selectedBoxes.multipass].filter(Boolean));
      
      container.innerHTML = Object.entries(boxCategories).map(([key, boxes]) => {
        const info = categoryInfo[key] || { name: key, class: '' };
        const enabledCount = boxes.filter(b => enabledBoxes.has(b.name)).length;
        const isCollapsed = collapsedCategories.has(key) ? ' collapsed' : '';
        return `<div class="box-category" data-category="${key}">
          <div class="category-header${isCollapsed}" onclick="toggleCategory(this, '${key}')">
            <div class="category-toggle">▼</div><div class="category-name ${info.class}">${info.name}</div>
            <div class="category-count">${enabledCount}/${boxes.length}</div></div>
          <div class="category-boxes">${boxes.map(b => {
            const isEnabled = enabledBoxes.has(b.name), isSelected = allSelected.has(b.name);
            return `<div class="box-item ${isEnabled ? 'enabled' : 'disabled'} ${isSelected ? 'selected' : ''}" onclick="toggleBox('${b.name}')">
              <div class="box-check"></div><div class="box-info">
              <div class="box-name">${b.name}</div><div class="box-dims">${b.length}" × ${b.width}" × ${b.height}"</div></div></div>`;
          }).join('')}</div></div>`;
      }).join('');
    }
    
    function toggleCategory(header, key) { 
      header.classList.toggle('collapsed'); 
      if (collapsedCategories.has(key)) collapsedCategories.delete(key);
      else collapsedCategories.add(key);
    }
    function toggleBox(name) { if (enabledBoxes.has(name)) enabledBoxes.delete(name); else enabledBoxes.add(name); renderBoxCategories(); runCartonization(); }
    function toggleAllBoxes(enable) { Object.values(boxCategories).flat().forEach(b => { if (enable) enabledBoxes.add(b.name); else enabledBoxes.delete(b.name); }); renderBoxCategories(); runCartonization(); }
    
    async function loadData() {
      try {
        const [productsRes, boxesRes] = await Promise.all([fetch('products.json'), fetch('boxes.json')]);
        products = await productsRes.json();
        boxCategories = await boxesRes.json();
        Object.values(boxCategories).flat().forEach(b => enabledBoxes.add(b.name));
        cartonService = new CartonizationService(Object.values(boxCategories).flat());
        renderProducts(); renderBoxCategories();
        console.log(`Loaded ${products.length} products, ${Object.values(boxCategories).flat().length} boxes`);
      } catch (error) { console.error('Error loading data:', error); }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      initThreeJS(); loadData();
      document.getElementById('search').addEventListener('input', (e) => renderProducts(e.target.value));
      document.getElementById('padding-input').addEventListener('change', runCartonization);
      document.getElementById('dim-divisor').addEventListener('change', runCartonization);
    });
  </script>
</body>
</html>
